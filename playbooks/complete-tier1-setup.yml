---
# BigBrotherAnalytics - Complete Tier 1 Setup (All-in-One)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# This playbook installs EVERYTHING needed for Tier 1 development in one run:
#   - Homebrew (package manager)
#   - GCC 15 with C++23 support
#   - Python 3.14+ with uv environment manager
#   - CMake 4.1.2+, Ninja build system
#   - OpenMP, OpenMPI 5.x
#   - UPC++ 2024.3.0 and GASNet-EX (PGAS)
#   - Intel MKL (Math Kernel Library)
#   - NVIDIA CUDA 12.3+ (if GPU present)
#   - DuckDB (via Python) - PRIMARY DATABASE FOR TIER 1
#   - Redis cache (optional, for caching)
#   - PyTorch with CUDA support
#   - Hugging Face Transformers
#   - All ML/AI frameworks
#   - Static analysis tools (mypy, pylint, pytype, clang-tidy, cppcheck)
#   - Complete verification
#
# NOTE: PostgreSQL is NOT installed in Tier 1 POC!
#       We use DuckDB-first approach for rapid validation.
#       Add PostgreSQL later (Tier 2) only after proving profitability.
#       See docs/architecture/database-strategy-analysis.md for rationale.
#
# Supported Operating Systems:
#   âœ“ Red Hat Enterprise Linux (RHEL) 9+
#   âœ“ Ubuntu Server 22.04 LTS
#   âœ“ Ubuntu Desktop 22.04 LTS
#   âœ“ WSL2 Ubuntu 22.04 (Windows Subsystem for Linux)
#   âœ“ Fedora 38+
#   âœ“ CentOS Stream 9+
#
# Installation Strategy:
#   - Homebrew: Primary method for GCC 15, Python 3.14, CMake, Ansible, MPI
#     (Provides latest versions, consistent across all OSes)
#   - System Package Manager (dnf/apt): Only for OS-specific packages
#     (PostgreSQL, Redis, kernel headers, system utilities)
#   - From Source: UPC++, GASNet-EX (for optimization)
#   - Python (uv): ALL Python packages managed via uv (NOT pip)
#     (10-100x faster than pip, better dependency resolution)
#
# Idempotency:
#   âœ“ Safe to re-run - won't reinstall if already present
#   âœ“ Uses 'creates:' checks for build tasks
#   âœ“ Package managers handle already-installed packages
#   âœ“ Can update existing installation
#   âœ“ Won't duplicate configuration
#
# Usage:
#   ansible-playbook playbooks/complete-tier1-setup.yml
#
# To uninstall:
#   ansible-playbook playbooks/uninstall-tier1.yml
#
# Estimated time:
#   - First run: 2-4 hours (builds from source)
#   - Subsequent runs: 10-30 minutes (only updates)
#
# Cost: $0 (all open-source)
#
# WSL Note: Systemd might not be available. Playbook detects and handles gracefully.
# Reference: https://github.com/oldboldpilot/ClusterSetupAndConfigs

- name: BigBrotherAnalytics - Complete Tier 1 Development Environment Setup
  hosts: localhost
  become: yes
  vars:
    gcc_version: "15"
    python_version: "3.14"
    cuda_version: "13.0"              # Latest CUDA Toolkit
    pytorch_cuda_version: "cu130"      # PyTorch CUDA version string
    postgresql_version: "16"
    gasnet_version: "2024.5.0"
    upcxx_version: "2024.3.0"
    install_prefix: "/opt/berkeley"
    homebrew_prefix: "/home/linuxbrew/.linuxbrew"
    project_dir: "/opt/bigbrother"
    num_build_jobs: "{{ ansible_processor_vcpus }}"
    user: "{{ ansible_user_id }}"

  tasks:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 1: System Dependencies
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Update package cache (RHEL)
      dnf:
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: Update package cache (Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Development Tools group (RHEL)
      dnf:
        name: "@Development Tools"
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install base system dependencies (RHEL)
      dnf:
        name:
          - git
          - wget
          - curl
          - vim
          - htop
          - tmux
          - screen
          - python3
          - python3-pip
          - gcc
          - gcc-c++
          - make
          - kernel-devel
          - kernel-headers
          - pciutils
          - lshw
        state: latest
      when: ansible_os_family == "RedHat"

    - name: Install base system dependencies (Ubuntu)
      apt:
        name:
          - git
          - wget
          - curl
          - vim
          - htop
          - tmux
          - screen
          - python3
          - python3-pip
          - build-essential
          - linux-headers-{{ ansible_kernel }}
          - pciutils
          - lshw
          - software-properties-common
        state: latest
      when: ansible_os_family == "Debian"

    - name: Check if systemd is available (for WSL compatibility)
      shell: systemctl --version
      register: systemd_check
      failed_when: false
      changed_when: false

    - name: Detect if running in WSL
      shell: grep -qi microsoft /proc/version && echo "true" || echo "false"
      register: is_wsl
      changed_when: false

    - name: Display environment information
      debug:
        msg: |
          OS Family: {{ ansible_os_family }}
          Distribution: {{ ansible_distribution }}
          systemd Available: {{ systemd_check.rc == 0 }}
          Running in WSL: {{ is_wsl.stdout }}
          CPU Cores: {{ ansible_processor_vcpus }}

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 2: Homebrew Installation
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Check if Homebrew is installed
      stat:
        path: "{{ homebrew_prefix }}/bin/brew"
      register: homebrew_check

    - name: Install Homebrew
      shell: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      become_user: "{{ user }}"
      args:
        creates: "{{ homebrew_prefix }}/bin/brew"
      when: not homebrew_check.stat.exists

    - name: Add Homebrew to PATH for current session
      shell: 'eval "$({{ homebrew_prefix }}/bin/brew shellenv)"'
      become_user: "{{ user }}"

    - name: Add Homebrew to bashrc
      lineinfile:
        path: "/home/{{ user }}/.bashrc"
        line: 'eval "$({{ homebrew_prefix }}/bin/brew shellenv)"'
        create: yes
      become_user: "{{ user }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 3: C++23 Toolchain via Homebrew
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Install C++23 development toolchain via Homebrew
      homebrew:
        name:
          - gcc@{{ gcc_version }}     # GCC 15 with C++23
          - binutils                   # Latest GNU binutils
          - cmake                      # CMake 4.1.2+
          - ninja                      # Ninja build system
          - make                       # GNU Make
          - autoconf                   # Autotools
          - automake
          - libtool
          - pkg-config
          - llvm                       # LLVM 18+ (includes clang-tidy)
          - cppcheck                   # C++ static analyzer
        state: latest
      become_user: "{{ user }}"
      environment:
        PATH: "{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 4: Parallel Computing (OpenMP, MPI, UPC++)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Install parallel computing libraries via Homebrew
      homebrew:
        name:
          - open-mpi                   # OpenMPI 5.x
          - libomp                     # OpenMP runtime
        state: latest
      become_user: "{{ user }}"
      environment:
        PATH: "{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"

    - name: Create Berkeley components directory
      file:
        path: "{{ install_prefix }}"
        state: directory
        owner: "{{ user }}"
        mode: '0755'

    - name: Download GASNet-EX
      get_url:
        url: "https://gasnet.lbl.gov/download/GASNet-{{ gasnet_version }}.tar.gz"
        dest: "/tmp/GASNet-{{ gasnet_version }}.tar.gz"
      become_user: "{{ user }}"

    - name: Extract GASNet-EX
      unarchive:
        src: "/tmp/GASNet-{{ gasnet_version }}.tar.gz"
        dest: "/tmp/"
        remote_src: yes
      become_user: "{{ user }}"

    - name: Configure GASNet-EX
      shell: |
        {{ homebrew_prefix }}/bin/brew shellenv
        cd /tmp/GASNet-{{ gasnet_version }}
        ./configure \
          --prefix={{ install_prefix }}/gasnet \
          --enable-mpi \
          --enable-par \
          --enable-pshm \
          --with-mpi-cc={{ homebrew_prefix }}/bin/mpicc \
          --with-mpi-cxx={{ homebrew_prefix }}/bin/mpic++ \
          CC={{ homebrew_prefix }}/bin/gcc-{{ gcc_version }} \
          CXX={{ homebrew_prefix }}/bin/g++-{{ gcc_version }}
      become_user: "{{ user }}"
      args:
        creates: "/tmp/GASNet-{{ gasnet_version }}/Makefile"

    - name: Build and install GASNet-EX
      shell: |
        cd /tmp/GASNet-{{ gasnet_version }}
        make -j {{ num_build_jobs }}
        make install
      become_user: "{{ user }}"
      args:
        creates: "{{ install_prefix }}/gasnet/bin/gasnetrun_mpi"

    - name: Download UPC++
      get_url:
        url: "https://bitbucket.org/berkeleylab/upcxx/downloads/upcxx-{{ upcxx_version }}.tar.gz"
        dest: "/tmp/upcxx-{{ upcxx_version }}.tar.gz"
      become_user: "{{ user }}"

    - name: Extract UPC++
      unarchive:
        src: "/tmp/upcxx-{{ upcxx_version }}.tar.gz"
        dest: "/tmp/"
        remote_src: yes
      become_user: "{{ user }}"

    - name: Install UPC++
      shell: |
        cd /tmp/upcxx-{{ upcxx_version }}
        ./install {{ install_prefix }}/upcxx \
          --with-gasnet={{ install_prefix }}/gasnet \
          --with-cc={{ homebrew_prefix }}/bin/gcc-{{ gcc_version }} \
          --with-cxx={{ homebrew_prefix }}/bin/g++-{{ gcc_version }} \
          --with-mpi-cc={{ homebrew_prefix }}/bin/mpicc \
          --with-mpi-cxx={{ homebrew_prefix }}/bin/mpic++
      become_user: "{{ user }}"
      args:
        creates: "{{ install_prefix }}/upcxx/bin/upcxx"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 5: Intel MKL (Math Kernel Library)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Add Intel oneAPI repository (Ubuntu)
      shell: |
        wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | sudo tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
        echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
        apt update
      when: ansible_os_family == "Debian"

    - name: Install Intel MKL (Ubuntu)
      apt:
        name: intel-oneapi-mkl-devel
        state: latest
      when: ansible_os_family == "Debian"

    - name: Add Intel oneAPI repository (RHEL)
      shell: |
        tee > /tmp/oneAPI.repo << EOF
        [oneAPI]
        name=IntelÂ® oneAPI repository
        baseurl=https://yum.repos.intel.com/oneapi
        enabled=1
        gpgcheck=1
        repo_gpgcheck=1
        gpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
        EOF
        mv /tmp/oneAPI.repo /etc/yum.repos.d/
      when: ansible_os_family == "RedHat"

    - name: Install Intel MKL (RHEL)
      dnf:
        name: intel-oneapi-mkl-devel
        state: latest
      when: ansible_os_family == "RedHat"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 6: NVIDIA CUDA Toolkit
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Check if NVIDIA GPU is present
      shell: lspci | grep -i nvidia
      register: nvidia_check
      failed_when: false
      changed_when: false

    - name: Add NVIDIA CUDA repository (Ubuntu)
      shell: |
        wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
        dpkg -i cuda-keyring_1.1-1_all.deb
        apt update
      when:
        - ansible_os_family == "Debian"
        - nvidia_check.rc == 0

    - name: Install CUDA Toolkit 13.0 (Ubuntu)
      apt:
        name: cuda-toolkit-13-0
        state: latest
      when:
        - ansible_os_family == "Debian"
        - nvidia_check.rc == 0

    - name: Add NVIDIA CUDA repository (RHEL)
      shell: |
        dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo
        dnf clean all
      when:
        - ansible_os_family == "RedHat"
        - nvidia_check.rc == 0

    - name: Install CUDA Toolkit 13.0 (RHEL)
      dnf:
        name: cuda-toolkit-13-0
        state: latest
      when:
        - ansible_os_family == "RedHat"
        - nvidia_check.rc == 0

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 7: Python 3.14+ and uv Package Manager
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Install Python 3.14 via Homebrew
      homebrew:
        name: python@{{ python_version }}
        state: latest
      become_user: "{{ user }}"
      environment:
        PATH: "{{ homebrew_prefix }}/bin:{{ ansible_env.PATH }}"

    - name: Install uv (Rust-based Python package manager)
      shell: curl -LsSf https://astral.sh/uv/install.sh | sh
      become_user: "{{ user }}"
      args:
        creates: "/home/{{ user }}/.cargo/bin/uv"

    - name: Install Ansible via uv (for future playbook runs)
      shell: |
        source ~/.cargo/env
        ~/.cargo/bin/uv pip install --system ansible
      become_user: "{{ user }}"
      args:
        creates: "/home/{{ user }}/.local/bin/ansible"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 8: DuckDB (Embedded Analytics Database)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NOTE: DuckDB is installed via Python (uv) in SECTION 10
    #       No separate installation needed - it's embedded!
    #       PostgreSQL skipped for Tier 1 POC - add later if profitable

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 9: Redis Cache (Optional - for caching only)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NOTE: Redis is optional for Tier 1. Can skip to reduce complexity.
    #       Uncomment if you need caching, otherwise DuckDB handles everything.

    # Commented out for Tier 1 POC - Redis is optional
    # Uncomment if you need caching layer
    # - name: Install Redis (Ubuntu)
    #   apt:
    #     name: redis-server
    #     state: latest
    #   when: ansible_os_family == "Debian"

    # - name: Install Redis (RHEL)
    #   dnf:
    #     name: redis
    #     state: latest
    #   when: ansible_os_family == "RedHat"

    # Commented out for Tier 1 POC - Redis is optional
    # - name: Find Redis config file
    #   shell: |
    #     {% if ansible_os_family == "Debian" %}
    #     echo "/etc/redis/redis.conf"
    #     {% else %}
    #     echo "/etc/redis/redis.conf"
    #     {% endif %}
    #   register: redis_conf_path
    #   changed_when: false

    # - name: Configure Redis for BigBrotherAnalytics
    #   lineinfile:
    #     path: "{{ redis_conf_path.stdout }}"
    #     regexp: "{{ item.regexp }}"
    #     line: "{{ item.line }}"
    #   loop:
    #     - { regexp: '^maxmemory ', line: 'maxmemory 16gb' }
    #     - { regexp: '^maxmemory-policy', line: 'maxmemory-policy allkeys-lru' }

    # - name: Get Redis service name
    #   shell: |
    #     {% if ansible_os_family == "Debian" %}
    #     echo "redis-server"
    #     {% else %}
    #     echo "redis"
    #     {% endif %}
    #   register: redis_service_name
    #   changed_when: false

    # - name: Start and enable Redis (systemd)
    #   systemd:
    #     name: "{{ redis_service_name.stdout }}"
    #     state: started
    #     enabled: yes
    #   when: systemd_check.rc == 0

    # - name: Start Redis manually (WSL without systemd)
    #   shell: "redis-server {{ redis_conf_path.stdout }} --daemonize yes"
    #   when: systemd_check.rc != 0

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 10: Python Environment and ML/AI Frameworks
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Create project directory
      file:
        path: "{{ project_dir }}"
        state: directory
        owner: "{{ user }}"
        mode: '0755'

    - name: Clone BigBrotherAnalytics repository
      git:
        repo: 'https://github.com/oldboldpilot/BigBrotherAnalytics.git'
        dest: "{{ project_dir }}"
        version: master
      become_user: "{{ user }}"

    - name: Create Python virtual environment with uv
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        ~/.cargo/bin/uv venv --python {{ python_version }}
      become_user: "{{ user }}"
      args:
        creates: "{{ project_dir }}/.venv"

    - name: Install core Python packages
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        ~/.cargo/bin/uv pip install \
          numpy scipy pandas polars pyarrow \
          matplotlib seaborn plotly \
          scikit-learn xgboost lightgbm \
          duckdb sqlalchemy \
          fastapi uvicorn pydantic \
          streamlit dash jupyter jupyterlab
      become_user: "{{ user }}"
      # NOTE: Removed psycopg2-binary (PostgreSQL) and redis for Tier 1
      #       DuckDB is the primary database - zero setup, embedded!

    - name: Install Python static analysis tools
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        ~/.cargo/bin/uv pip install \
          mypy pylint pytype \
          black isort flake8 \
          pre-commit
      become_user: "{{ user }}"

    - name: Install PyTorch with CUDA 13.0 support
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        {% if nvidia_check.rc == 0 %}
        ~/.cargo/bin/uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/{{ pytorch_cuda_version }}
        {% else %}
        ~/.cargo/bin/uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        {% endif %}
      become_user: "{{ user }}"

    - name: Install ML/AI frameworks
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        ~/.cargo/bin/uv pip install \
          transformers accelerate \
          sentence-transformers \
          stable-baselines3 \
          gymnasium \
          torch-geometric \
          shap lime captum \
          vllm \
          spacy \
          nltk
      become_user: "{{ user }}"

    - name: Install GPU-accelerated libraries (if NVIDIA GPU present)
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        ~/.cargo/bin/uv pip install \
          cupy-cuda13x \
          nvidia-ml-py3
      become_user: "{{ user }}"
      when: nvidia_check.rc == 0

    - name: Download spaCy English model
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        python -m spacy download en_core_web_lg
      become_user: "{{ user }}"

    - name: Install web scraping and data collection tools
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        ~/.cargo/bin/uv pip install \
          scrapy playwright beautifulsoup4 \
          yfinance alpha-vantage fredapi \
          requests aiohttp httpx \
          apache-tika pdfplumber tabula-py \
          python-pptx python-docx openpyxl
      become_user: "{{ user }}"

    - name: Install Playwright browsers
      shell: |
        cd {{ project_dir }}
        source .venv/bin/activate
        playwright install chromium
      become_user: "{{ user }}"

    - name: Install monitoring and observability tools
      shell: |
        source ~/.cargo/env
        cd {{ project_dir }}
        source .venv/bin/activate
        ~/.cargo/bin/uv pip install \
          prometheus-client \
          sentry-sdk \
          python-json-logger
      become_user: "{{ user }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 11: Environment Configuration
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Create comprehensive environment file
      copy:
        dest: /etc/profile.d/bigbrother_env.sh
        content: |
          # BigBrotherAnalytics Complete Environment Configuration
          # Generated by Ansible playbook: complete-tier1-setup.yml

          # Homebrew
          eval "$({{ homebrew_prefix }}/bin/brew shellenv)"

          # Compilers
          export CC={{ homebrew_prefix }}/bin/gcc-{{ gcc_version }}
          export CXX={{ homebrew_prefix }}/bin/g++-{{ gcc_version }}
          export FC={{ homebrew_prefix }}/bin/gfortran-{{ gcc_version }}

          # MPI
          export MPICC={{ homebrew_prefix }}/bin/mpicc
          export MPICXX={{ homebrew_prefix }}/bin/mpic++

          # Static Analysis Tools
          export PATH={{ homebrew_prefix }}/opt/llvm/bin:$PATH
          export LDFLAGS="-L{{ homebrew_prefix }}/opt/llvm/lib $LDFLAGS"
          export CPPFLAGS="-I{{ homebrew_prefix }}/opt/llvm/include $CPPFLAGS"

          # Berkeley PGAS Components
          export BERKELEY_PREFIX={{ install_prefix }}
          export GASNET_HOME={{ install_prefix }}/gasnet
          export UPCXX_INSTALL={{ install_prefix }}/upcxx
          export PATH={{ install_prefix }}/upcxx/bin:{{ install_prefix }}/gasnet/bin:$PATH
          export LD_LIBRARY_PATH={{ install_prefix }}/upcxx/lib:{{ install_prefix }}/gasnet/lib:$LD_LIBRARY_PATH
          export UPCXX_GASNET_CONDUIT=mpi
          export UPCXX_NETWORK=mpi

          # CUDA (if installed)
          {% if nvidia_check.rc == 0 %}
          export PATH=/usr/local/cuda-{{ cuda_version }}/bin:$PATH
          export LD_LIBRARY_PATH=/usr/local/cuda-{{ cuda_version }}/lib64:$LD_LIBRARY_PATH
          export CUDA_HOME=/usr/local/cuda-{{ cuda_version }}
          {% endif %}

          # Intel MKL
          source /opt/intel/oneapi/setvars.sh --force > /dev/null 2>&1

          # Python
          export PYTHON_ENV={{ project_dir }}/.venv
          alias activate-bigbrother='source {{ project_dir }}/.venv/bin/activate'

          # Project
          export BIGBROTHER_HOME={{ project_dir }}
        mode: '0644'

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 12: Create Verification Script
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Create comprehensive verification script
      copy:
        dest: "{{ project_dir }}/scripts/verify_complete_setup.sh"
        content: |
          #!/bin/bash
          # BigBrotherAnalytics - Complete Tier 1 Setup Verification

          source /etc/profile.d/bigbrother_env.sh

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "BigBrotherAnalytics Tier 1 Setup Verification"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Function to check command
          check_command() {
              if command -v $1 &> /dev/null; then
                  echo "âœ“ $2: $($1 --version 2>&1 | head -1)"
              else
                  echo "âœ— $2: NOT FOUND"
              fi
          }

          # Check compilers
          echo "COMPILERS:"
          check_command "gcc-{{ gcc_version }}" "GCC {{ gcc_version }}"
          check_command "g++-{{ gcc_version }}" "G++ {{ gcc_version }}"
          check_command "cmake" "CMake"
          echo ""

          # Check static analysis tools
          echo "STATIC ANALYSIS TOOLS:"
          check_command "clang-tidy" "clang-tidy"
          check_command "cppcheck" "cppcheck"
          echo ""

          # Check parallel computing
          echo "PARALLEL COMPUTING:"
          check_command "mpirun" "OpenMPI"
          check_command "upcxx" "UPC++"
          check_command "gasnetrun_mpi" "GASNet-EX"
          echo ""

          # Check OpenMP
          echo -n "OpenMP: "
          echo '#include <omp.h>
          int main() { printf("%d threads\n", omp_get_max_threads()); return 0; }' | \
          gcc-{{ gcc_version }} -fopenmp -x c - -o /tmp/test_omp 2>/dev/null && \
          /tmp/test_omp && echo "âœ“" || echo "âœ—"

          # Check CUDA
          if command -v nvcc &> /dev/null; then
              echo "CUDA:"
              check_command "nvcc" "CUDA Compiler"
              nvidia-smi --query-gpu=name,memory.total --format=csv,noheader 2>/dev/null | \
                sed 's/^/  GPU: /'
              echo ""
          fi

          # Check Intel MKL
          if [ -d "/opt/intel/oneapi" ]; then
              echo "âœ“ Intel MKL: Installed"
          else
              echo "âœ— Intel MKL: NOT FOUND"
          fi
          echo ""

          # Check databases
          echo "DATABASES:"
          echo "  DuckDB: Embedded (check via Python below)"
          echo "  Note: PostgreSQL/Redis skipped for Tier 1 POC"
          echo ""

          # Check Python
          echo "PYTHON:"
          check_command "python{{ python_version }}" "Python {{ python_version }}"
          check_command "~/.cargo/bin/uv" "uv package manager"
          echo ""

          # Activate venv and check Python packages
          if [ -f "{{ project_dir }}/.venv/bin/activate" ]; then
              source {{ project_dir }}/.venv/bin/activate

              echo "PYTHON PACKAGES:"
              python -c "import numpy; print(f'âœ“ NumPy: {numpy.__version__}')" 2>/dev/null || echo "âœ— NumPy"
              python -c "import pandas; print(f'âœ“ Pandas: {pandas.__version__}')" 2>/dev/null || echo "âœ— Pandas"
              python -c "import torch; print(f'âœ“ PyTorch: {torch.__version__}')" 2>/dev/null || echo "âœ— PyTorch"
              python -c "import torch; print(f'  CUDA Available: {torch.cuda.is_available()}')" 2>/dev/null
              python -c "import transformers; print(f'âœ“ Transformers: {transformers.__version__}')" 2>/dev/null || echo "âœ— Transformers"
              python -c "import duckdb; print(f'âœ“ DuckDB: {duckdb.__version__}')" 2>/dev/null || echo "âœ— DuckDB"
              python -c "import xgboost; print(f'âœ“ XGBoost: {xgboost.__version__}')" 2>/dev/null || echo "âœ— XGBoost"
              python -c "import shap; print(f'âœ“ SHAP: {shap.__version__}')" 2>/dev/null || echo "âœ— SHAP"
              python -c "import stable_baselines3; print(f'âœ“ Stable-Baselines3: {stable_baselines3.__version__}')" 2>/dev/null || echo "âœ— SB3"
              echo ""

              echo "PYTHON STATIC ANALYSIS TOOLS:"
              python -c "import mypy; print(f'âœ“ mypy: {mypy.__version__}')" 2>/dev/null || echo "âœ— mypy"
              check_command "pylint" "pylint"
              check_command "pytype" "pytype"
              echo ""

              deactivate
          fi

          # Summary
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Verification Complete!"
          echo ""
          echo "To activate environment:"
          echo "  source /etc/profile.d/bigbrother_env.sh"
          echo "  cd {{ project_dir }}"
          echo "  source .venv/bin/activate"
          echo ""
          echo "To start development:"
          echo "  cd {{ project_dir }}"
          echo "  source .venv/bin/activate"
          echo "  jupyter lab  # or streamlit run scripts/dashboard.py"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        mode: '0755'
        owner: "{{ user }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 13: Run Verification
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Run verification script
      shell: "{{ project_dir }}/scripts/verify_complete_setup.sh"
      register: verification_output
      become_user: "{{ user }}"

    - name: Display verification results
      debug:
        msg: "{{ verification_output.stdout_lines }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 14: Create Quick Start Guide
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Create quick start guide
      copy:
        dest: "{{ project_dir }}/QUICKSTART.md"
        content: |
          # BigBrotherAnalytics - Quick Start Guide

          Your Tier 1 development environment has been set up successfully!

          ## What Was Installed

          ### Compilers & Build Tools
          - GCC {{ gcc_version }} with C++23 support
          - CMake 4.1.2+, Ninja build system
          - Latest GNU binutils

          ### Parallel Computing
          - OpenMP (multi-threading)
          - OpenMPI 5.x (distributed computing)
          - UPC++ {{ upcxx_version }} with GASNet-EX (PGAS)

          ### GPU Computing (if NVIDIA GPU detected)
          - NVIDIA CUDA {{ cuda_version }}
          - cuBLAS, cuFFT, cuSOLVER

          ### Math Libraries
          - Intel MKL (BLAS, LAPACK, FFT, Statistics)

          ### Databases
          - DuckDB (via Python, embedded analytics) - PRIMARY DATABASE
            - Zero setup, instant start
            - Perfect for backtesting and analytics
            - ACID compliant, handles real-time trading

          Note: PostgreSQL/Redis not installed in Tier 1 POC
                Add later (Tier 2) only after proving profitability
                See docs/architecture/database-strategy-analysis.md

          ### Python {{ python_version }} with ML/AI
          - PyTorch with CUDA support
          - Transformers (Hugging Face)
          - Stable-Baselines3 (RL)
          - XGBoost, LightGBM
          - SHAP (explainability)
          - spaCy, NLTK (NLP)
          - Pandas, Polars, NumPy
          - Plotly, Streamlit, Dash
          - And many more...

          ### Code Quality & Static Analysis
          - **Python:** mypy, pylint, pytype (type checking and linting)
          - **C++:** clang-tidy (C++ Core Guidelines), cppcheck (static analysis)
          - **Formatters:** black, isort (Python), clang-format (C++)
          - **Pre-commit hooks:** Automated quality checks before commits

          ## Getting Started

          ### 1. Activate Environment
          ```bash
          source /etc/profile.d/bigbrother_env.sh
          cd {{ project_dir }}
          source .venv/bin/activate
          ```

          ### 2. Collect Free Historical Data
          ```bash
          python scripts/collect_free_data.py
          # Downloads 10 years of data from Yahoo Finance, FRED, SEC
          # Takes ~3 hours, completely free
          ```

          ### 3. Run POC for Each Tool

          **Market Intelligence Engine POC:**
          ```bash
          python poc/mi_simple_poc.py
          ```

          **Correlation Analysis Tool POC:**
          ```bash
          python poc/correlation_poc.py
          ```

          **Trading Decision Engine POC:**
          ```bash
          python poc/trading_simple_poc.py
          ```

          ### 4. Launch Dashboard
          ```bash
          streamlit run poc/trading_dashboard_poc.py
          # Open browser to http://localhost:8501
          ```

          ### 5. Run Validation Framework
          ```bash
          python scripts/run_backtest.py
          python scripts/walk_forward_validation.py
          ```

          ## Next Steps

          - Review architecture documents in `docs/architecture/`
          - Read PRD in `docs/PRD.md`
          - Follow POC guides in architecture documents
          - Validate algorithms with free data (3-6 months)
          - Only buy eBay 64-core server after POC proves profitable!

          ## Cost

          - Tier 1 POC: $0/month (all free)
          - Time to validate: 3-6 months
          - Investment before spending: $0

          ## References

          - PRD: docs/PRD.md
          - Architecture docs: docs/architecture/
          - ClusterSetupAndConfigs: https://github.com/oldboldpilot/ClusterSetupAndConfigs

          ## Support

          - Issues: https://github.com/oldboldpilot/BigBrotherAnalytics/issues
          - PGAS Setup: https://github.com/oldboldpilot/ClusterSetupAndConfigs

          Happy Trading! ğŸ“ˆ
        mode: '0644'
        owner: "{{ user }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # FINAL MESSAGE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Installation complete
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          BigBrotherAnalytics Tier 1 Setup COMPLETE!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          âœ“ C++23 Toolchain (GCC 15, CMake, Ninja)
          âœ“ Parallel Computing (OpenMP, MPI, UPC++, GASNet-EX)
          âœ“ GPU Computing (CUDA {{ cuda_version }})
          âœ“ Math Libraries (Intel MKL)
          âœ“ Database (DuckDB - embedded, zero setup)
          âœ“ Python {{ python_version }} with ML/AI frameworks
          âœ“ PyTorch with CUDA support
          âœ“ Hugging Face Transformers
          âœ“ Static Analysis Tools (mypy, pylint, pytype, clang-tidy, cppcheck)
          âœ“ Complete environment configured

          NOTE: Using DuckDB-first approach for rapid validation
                PostgreSQL/Redis deferred until Tier 2 (after profitability)

          Installation Directory: {{ project_dir }}
          Quick Start Guide: {{ project_dir }}/QUICKSTART.md
          Verification: {{ project_dir }}/scripts/verify_complete_setup.sh

          Next Steps:
            1. source /etc/profile.d/bigbrother_env.sh
            2. cd {{ project_dir }}
            3. source .venv/bin/activate
            4. Read QUICKSTART.md
            5. Start with: python scripts/collect_free_data.py

          Total Cost: $0 (100% open-source)
          Ready for Tier 1 POC!

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Usage:
# ------
# ansible-playbook playbooks/complete-tier1-setup.yml
#
# This will take 2-4 hours depending on:
#   - Internet speed (downloading packages)
#   - CPU cores (building from source)
#   - Whether GPU is present (CUDA installation)
#
# After completion:
#   source /etc/profile.d/bigbrother_env.sh
#   cd /opt/bigbrother
#   source .venv/bin/activate
#   ./scripts/verify_complete_setup.sh
