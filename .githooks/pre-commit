#!/bin/bash
# BigBrotherAnalytics Pre-Commit Hook
# Enforces C++23 coding standards before each commit
#
# Author: Olumuyiwa Oluwasanmi
# Date: 2025-11-08

set -e

echo "üîç Running pre-commit standards checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged C++ files
STAGED_CPP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|cppm|hpp|h)$' || true)

if [ -z "$STAGED_CPP_FILES" ]; then
    echo "‚úÖ No C++ files to check"
    exit 0
fi

echo "üìù Checking ${#STAGED_CPP_FILES[@]} C++ files..."

violations=0

# Check 1: Trailing Return Syntax
echo ""
echo "1Ô∏è‚É£  Checking trailing return syntax..."
for file in $STAGED_CPP_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi

    # Skip test files and external dependencies
    if echo "$file" | grep -q "test\|external\|third_party"; then
        continue
    fi

    # Check for old-style function declarations
    old_style=$(grep -n "^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_:]*[[:space:]]\+[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*(" "$file" | \
                grep -v "auto\|operator\|~\|if\|while\|for\|switch\|template\|namespace" | \
                grep -v "//" | head -3) || true

    if [ -n "$old_style" ]; then
        echo -e "${RED}‚ùå $file: Found old-style function syntax${NC}"
        echo "$old_style"
        violations=$((violations + 1))
    fi
done

if [ $violations -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Trailing return syntax check passed${NC}"
fi

# Check 2: [[nodiscard]] on getters
echo ""
echo "2Ô∏è‚É£  Checking [[nodiscard]] attributes..."
nodiscard_violations=0

for file in $STAGED_CPP_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi

    # Look for getter methods without [[nodiscard]]
    missing_nodiscard=$(grep -n "auto get.*() const.*->" "$file" | grep -v "\[\[nodiscard\]\]" | head -2) || true

    if [ -n "$missing_nodiscard" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  $file: Consider [[nodiscard]] for getter methods${NC}"
        nodiscard_violations=$((nodiscard_violations + 1))
    fi
done

if [ $nodiscard_violations -eq 0 ]; then
    echo -e "${GREEN}‚úÖ [[nodiscard]] check passed${NC}"
fi

# Check 3: Module structure (for .cppm files)
echo ""
echo "3Ô∏è‚É£  Checking C++23 module structure..."
module_violations=0

for file in $STAGED_CPP_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi

    # Only check .cppm files
    if ! echo "$file" | grep -q "\.cppm$"; then
        continue
    fi

    # Must have export module declaration
    if ! grep -q "^export module" "$file"; then
        echo -e "${RED}‚ùå $file: Missing 'export module' declaration${NC}"
        module_violations=$((module_violations + 1))
    fi

    # Check for proper module fragment order
    if grep -q "^module;" "$file" && grep -q "^export module" "$file"; then
        module_line=$(grep -n "^module;" "$file" | cut -d: -f1 | head -1)
        export_line=$(grep -n "^export module" "$file" | cut -d: -f1 | head -1)

        if [ "$module_line" -gt "$export_line" ]; then
            echo -e "${RED}‚ùå $file: 'module;' must come before 'export module'${NC}"
            module_violations=$((module_violations + 1))
        fi
    fi
done

if [ $module_violations -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Module structure check passed${NC}"
fi

# Check 4: Documentation
echo ""
echo "4Ô∏è‚É£  Checking documentation..."
doc_violations=0

for file in $STAGED_CPP_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi

    # Only check module files
    if ! echo "$file" | grep -q "\.cppm$"; then
        continue
    fi

    # Check for file-level documentation
    if ! head -20 "$file" | grep -q "/\*\*"; then
        echo -e "${YELLOW}‚ö†Ô∏è  $file: Consider adding file-level documentation${NC}"
        doc_violations=$((doc_violations + 1))
    fi
done

if [ $doc_violations -eq 0 ]; then
    echo -e "${GREEN}‚úÖ Documentation check passed${NC}"
fi

# Check 5: Run clang-format (if available)
echo ""
echo "5Ô∏è‚É£  Checking code formatting..."
if command -v clang-format &> /dev/null; then
    format_violations=0

    for file in $STAGED_CPP_FILES; do
        if [ ! -f "$file" ]; then
            continue
        fi

        # Check if file needs formatting
        if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  $file: Needs formatting (run: clang-format -i $file)${NC}"
            format_violations=$((format_violations + 1))
        fi
    done

    if [ $format_violations -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Code formatting check passed${NC}"
    else
        echo -e "${YELLOW}üí° Tip: Run 'clang-format -i <file>' to auto-format${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  clang-format not found, skipping formatting check${NC}"
fi

# Summary
echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

total_violations=$((violations + module_violations))

if [ $total_violations -gt 0 ]; then
    echo -e "${RED}‚ùå Pre-commit checks failed with $total_violations violations${NC}"
    echo ""
    echo "üìö Coding Standards:"
    echo "  - All functions must use trailing return syntax: auto func() -> ReturnType"
    echo "  - Modules must have proper structure: module;, export module, export namespace"
    echo "  - Use [[nodiscard]] for all getter methods"
    echo "  - Document all public modules and APIs"
    echo ""
    echo "See docs/CODING_STANDARDS.md for complete guidelines"
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
    echo ""
    echo "üí° Warnings: $((nodiscard_violations + doc_violations))"
    echo "   These are suggestions, not blocking errors"
    exit 0
fi
